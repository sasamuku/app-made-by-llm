# 障害報告書: タスクステータスの列挙型への移行

## 概要

タスク管理アプリケーションにおいて、タスクのステータス管理を文字列型から列挙型 (Enum) に移行する過程で発生した問題と解決策について報告します。

## 発生日時

2025年3月7日

## 影響範囲

- タスク作成・更新機能
- タスク一覧表示機能

## 問題の詳細

1. **スキーマ変更**: `Task` モデルの `status` フィールドを文字列型から `TaskStatus` 列挙型 (`TODO`, `IN_PROGRESS`, `DONE`) に変更しました。

2. **発生した問題**:
   - フロントエンドから送信されるステータス値 (`pending`, `in-progress`, `completed`) が新しい列挙型の値と一致せず、API呼び出し時にエラーが発生しました。
   - エラーメッセージ: `Invalid value for argument status. Expected TaskStatus.`

3. **影響**:
   - タスクの作成・更新機能が一時的に使用不可となりました。

## 原因

1. スキーマ変更時に、フロントエンドとバックエンドの間のデータ形式の整合性が考慮されていませんでした。
2. 特に以下の不一致がありました:
   - フロントエンド: `pending`, `in-progress`, `completed`
   - バックエンド (新Enum): `TODO`, `IN_PROGRESS`, `DONE`

## 解決策

1. **API層での変換処理の追加**:
   - `app/api/tasks/route.ts` のPOST/PUT処理において、フロントエンドから送信される文字列値を適切な列挙型値に変換するロジックを追加しました。
   ```typescript
   if (status === "in-progress") {
     status = "IN_PROGRESS";
   } else if (status === "todo") {
     status = "TODO";
   } else if (status === "done") {
     status = "DONE";
   }
   ```

2. **フロントエンド側の更新**:
   - `app/components/TaskManager.tsx` のフォームとタスク表示部分を更新し、新しい列挙型の値を使用するように変更しました。
   - 初期値やリセット値も `TODO` に統一しました。

## 教訓と今後の対策

1. **スキーマ変更時の影響範囲の事前確認**:
   - スキーマ変更を行う際は、フロントエンドとの整合性を含めた影響範囲を事前に確認する必要があります。
   - 特に列挙型への変更は、文字列との比較が厳密になるため注意が必要です。

2. **段階的な移行の検討**:
   - 大きな変更を行う場合は、一時的な互換性レイヤーを設けるなど、段階的な移行を検討します。

3. **自動テストの強化**:
   - API層とフロントエンドの整合性を確認する自動テストを追加し、同様の問題を早期に検出できるようにします。

## 結論

タスクステータスの列挙型への移行は、アプリケーションの型安全性を高め、将来的な拡張性を向上させる重要な変更でした。今回の問題は、フロントエンドとバックエンドの整合性を確保するための対応を行うことで解決しました。今後のスキーマ変更においては、今回の教訓を活かし、より慎重な計画と実装を行っていきます。
